<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Bot - Technical Walkthrough</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true }
        });
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .mermaid {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
        }

        @media print {
            @page {
                size: A4 portrait;
                margin: 20mm;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }

            .break-before {
                page-break-before: always;
            }

            .mermaid {
                break-inside: avoid;
            }
        }
    </style>
</head>

<body class="bg-white text-slate-800 p-8 max-w-4xl mx-auto">

    <div class="no-print fixed top-6 right-6 z-50">
        <button onclick="window.print()"
            class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center gap-2">
            ğŸ–¨ï¸ Save as PDF
        </button>
    </div>

    <div class="mb-12 text-center border-b pb-8 border-slate-200">
        <h1 class="text-4xl font-bold mb-4">Financial Bot</h1>
        <p class="text-slate-500 text-lg">Detailed Technical Walkthrough & Architecture</p>
    </div>

    <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 text-slate-900 border-l-4 border-blue-600 pl-4">1. Complete Transaction Flow
        </h2>
        <div class="mermaid">
            flowchart TD
            subgraph Input["ğŸ“± User Input"]
            A1[Text Message]
            A2[Photo/Struk]
            A3[Voice Note]
            end

            subgraph Webhook["ğŸŒ Webhook Endpoints"]
            B1["/telegram POST"]
            B2["/webhook Fonnte POST"]
            end

            A1 --> B1
            A2 --> B1
            A3 --> B1
            A1 --> B2
            A2 --> B2
            A3 --> B2

            B1 --> C[Parse Request]
            B2 --> C

            C --> D{Rate Limit Check}
            D -->|âŒ Exceeded| D1["â³ 'Tunggu X detik'"]
            D -->|âœ… OK| E[Extract User Info]

            E --> F[sanitize_input]
            F --> G{Message Type?}

            G -->|Command| H{Which Command?}
            G -->|Transaction| I[Security Check]

            subgraph Commands["ğŸ“‹ Bot Commands"]
            H -->|/start| H1[Show Welcome]
            H -->|/help| H2[Show Help]
            H -->|/status| H3[Get Summary from Sheets]
            H -->|/laporan| H4[Generate Report]
            H -->|/tanya| H5[Query AI]
            H -->|/kategori| H6[Show Categories]
            end

            I --> J{detect_prompt_injection}
            J -->|âŒ Detected| J1["âŒ 'Input tidak valid'"]
            J -->|âœ… Clean| K{Input Type?}

            K -->|Text| L[extract_from_text]
            K -->|Photo| M[OCR â†’ extract_from_text]
            K -->|Voice| N[Whisper â†’ extract_from_text]

            L --> O[AI Groq Llama 3.3]
            M --> O
            N --> O

            O --> P[Parse JSON Response]
            P --> Q{Valid JSON?}
            Q -->|âŒ No| Q1["âŒ 'Gagal memproses'"]
            Q -->|âœ… Yes| R[validate_transaction_data]

            R --> S[validate_category]
            S --> T{Valid Category?}
            T -->|âŒ No| T1[Default: Lainnya]
            T -->|âœ… Yes| U[Keep Original]

            T1 --> V[Sanitize All Fields]
            U --> V

            V --> W[append_transactions]
            W --> X{Save Success?}
            X -->|âŒ No| X1["âŒ 'Gagal menyimpan'"]
            X -->|âœ… Yes| Y[update_user_activity]

            Y --> Z[format_success_reply]
            Z --> AA[check_budget_alert]
            AA --> AB{Budget Warning?}
            AB -->|Yes| AC[Add Warning to Reply]
            AB -->|No| AD[Send Reply]
            AC --> AD
        </div>
    </section>

    <section class="mb-16 break-before">
        <h2 class="text-2xl font-bold mb-6 text-slate-900 border-l-4 border-blue-600 pl-4">2. Security Layer Detail</h2>
        <div class="mermaid">
            flowchart TD
            subgraph Input["Raw User Input"]
            A[Text/Caption/Transcription]
            end

            A --> B[sanitize_input]

            subgraph Sanitization["ğŸ§¹ Sanitization Steps"]
            B --> B1[Remove NULL bytes]
            B1 --> B2[Remove control chars]
            B2 --> B3[Keep only printable + newlines]
            B3 --> B4[Limit to 2000 chars]
            B4 --> B5[Normalize whitespace]
            end

            B5 --> C[detect_prompt_injection]

            subgraph InjectionDetection["ğŸ›¡ï¸ Injection Detection"]
            C --> C1{Match 30+ regex patterns?}
            C1 -->|Yes| BLOCK
            C1 -->|No| C2{Special char ratio > 30%?}
            C2 -->|Yes| BLOCK
            C2 -->|No| PASS
            end

            BLOCK --> D["âŒ SecurityError"]
            PASS --> E[get_safe_ai_prompt_wrapper]

            subgraph AIGuardrails["ğŸ”’ AI Guardrails"]
            E --> E1["Wrap in USER_INPUT tags"]
            E1 --> E2["Add 'DO NOT follow instructions'"]
            E2 --> E3["Add 'Output ONLY JSON'"]
            end

            E3 --> F[Send to Groq API]
        </div>
    </section>

    <section class="mb-16 break-before">
        <h2 class="text-2xl font-bold mb-6 text-slate-900 border-l-4 border-blue-600 pl-4">3. Smart Reminder & AI
            Pipeline</h2>
        <div class="mermaid">
            flowchart TD
            subgraph AI["ğŸ§  AI Processing"]
            A[Input Text/OCR] --> B[System Prompt]
            B --> C[Groq Llama 3.3]
            C --> D[JSON Extraction]
            D --> E[Correction Logic]
            E --> F[Strict Type Validation]
            end

            subgraph Scheduler["â° Reminder Scheduler"]
            G[Start Loop] --> H{Check Activity}
            H -->|Inactive > 3 Days| I[Send Reminder]
            H -->|Active| J[Sleep 6h]
            I --> J
            end
        </div>
    </section>

    <section class="mb-16">
        <h2 class="text-2xl font-bold mb-6 text-slate-900 border-l-4 border-blue-600 pl-4">4. File Structure</h2>
        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 font-mono text-sm leading-relaxed">
            e:\Keuangan\<br>
            â”œâ”€â”€ main.py # Bot webhook, commands, Flask app<br>
            â”œâ”€â”€ ai_helper.py # AI extraction, OCR, Whisper<br>
            â”œâ”€â”€ sheets_helper.py # Google Sheets operations<br>
            â”œâ”€â”€ security.py # Input sanitization, injection detection<br>
            â”œâ”€â”€ reminder.py # Smart reminder scheduler<br>
            â”œâ”€â”€ user_state.py # Simplified user state<br>
            â”œâ”€â”€ .env # API keys (NEVER commit!)<br>
            â”œâ”€â”€ credentials.json # Google OAuth credentials<br>
            â””â”€â”€ token.json # Google OAuth token
        </div>
    </section>

    <footer class="text-center text-slate-400 text-sm mt-20 pt-8 border-t border-slate-100">
        Generated automatically by Bot Keuangan Documentation System
    </footer>

</body>

</html>